-- 3 dodaj postgis
CREATE EXTENSION postgis;

-- 4 zrob tabele
CREATE TABLE buildings(
	id SERIAL PRIMARY KEY,
  geometry GEOMETRY(POLYGON, 0),
  name TEXT
);

CREATE TABLE roads(
	id SERIAL PRIMARY KEY,
  geometry GEOMETRY(LINESTRING, 0),
  name TEXT
);

CREATE TABLE poi(
	id SERIAL PRIMARY KEY,
  geometry GEOMETRY(POINT, 0),
  name TEXT
);

-- 5 ustawienie danych
INSERT INTO buildings (geometry, name)
VALUES
  (ST_GeomFromText('POLYGON((8 4, 10.5 4, 10.5 1.5, 8 1.5, 8 4))', 0), 'BuildingA'),
  (ST_GeomFromText('POLYGON((4 5, 6 5, 6 7, 4 7, 4 5))', 0), 'BuildingB'),
  (ST_GeomFromText('POLYGON((3 6, 5 6, 5 8, 3 8, 3 6))', 0), 'BuildingC'),
  (ST_GeomFromText('POLYGON((9 8, 10 8, 10 9, 9 9, 9 8))', 0), 'BuildingD'),
  (ST_GeomFromText('POLYGON((1 1, 2 1, 2 2, 1 2, 1 1))', 0), 'BuildingF');

INSERT INTO roads (geometry, name)
VALUES 
	(ST_GeomFromText('LINESTRING(0 4.5, 12 4.5)', 0), 'RoadX'),
	(ST_GeomFromText('LINESTRING(7.5 0, 7.5 10.5)', 0), 'RoadY');

INSERT INTO poi (geometry, name)
VALUES 
	(ST_GeomFromText('POINT(5.5 1.5)', 0), 'H'),
	(ST_GeomFromText('POINT(9.5 6)', 0), 'I'),
	(ST_GeomFromText('POINT(6.5 6)', 0), 'J'),
	(ST_GeomFromText('POINT(6 9.5)', 0), 'K'),
	(ST_GeomFromText('POINT(1 3.5)', 0), 'G');

-- 6 zadania

-- a - calkowita dlugosc drog
SELECT(SUM(ST_LENGTH(geometry))) AS dlugosc_drog
FROM roads;

-- b - geometria wkt, pole, obwod
SELECT  ST_AsText(geometry) AS geometria,
    	ST_Area(geometry) AS pole,
    	ST_Perimeter(geometry) AS obwod
FROM buildings
WHERE name = 'BuildingA';

-- c - nazwy i pola poligonów w warstwie budynki, alfabetycznie
SELECT name, ST_Area(geometry) as pole
FROM buildings
ORDER BY name ASC;

-- d - nazwy i obwody 2 najwiekszych
SELECT name AS dwa_najwieksze, ST_Perimeter(geometry) AS obwod
FROM buildings
ORDER BY ST_Area(geometry) DESC
LIMIT 2;

-- e - najkrotsza odleglosc miedzy budynkiem C i punktem K
SELECT ROUND(ST_Distance(
    (SELECT geometry FROM buildings WHERE name = 'BuildingC'),
    (SELECT geometry FROM poi WHERE name = 'K'))::numeric, 4) 
	AS odleglosc;

-- f - pole czesci budynku c ktore jest w odleglosci >0.5 od budynku b
SELECT ROUND(ST_Area(
	ST_DIFFERENCE( -- part of geometry A that does not intersect geometry B
	c.geometry, ST_BUFFER(b.geometry, 0.5)))::numeric, 4) AS pole 
FROM buildings b, buildings c
WHERE b.name = 'BuildingB' AND c.name = 'BuildingC';

-- g - budynki, których centroid powyżej drogi RoadX
SELECT b.name AS budynki_powyzej_roadx
FROM buildings b
JOIN roads r ON r.name = 'RoadX'
WHERE ST_Y(ST_Centroid(b.geometry)) > ST_Y(ST_Centroid(r.geometry));

-- h - pole powierzchni części budynku BuildingC i poligonu o współrzędnych (4 7, 6 7, 6 8, 4 8, 4 7)
-- które nie są wspólne dla tych dwóch obiektów.
SELECT 
    ST_Area(
    ST_SymDifference( -- portions of geonetries A and B that do not intersect
    	b.geometry,
        ST_GeomFromText('POLYGON((4 7, 6 7, 6 8, 4 8, 4 7))'))
    ) AS pole_pow_niewspolne
FROM buildings b
WHERE b.name = 'BuildingC';


